<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kasir & Stok Toko Bangunan ‚Äî Firebase</title>
  <style>
    :root{--bg:#f6f7fb;--card:#ffffff;--pri:#2563eb;--ok:#16a34a;--warn:#ea580c;--bad:#dc2626;--muted:#6b7280}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;background:var(--bg);color:#111}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--card);border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:10}
    header h1{font-size:18px;margin:0}
    header .user{font-size:14px;color:var(--muted)}
    .wrap{max-width:1050px;margin:18px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.04)}
    .p16{padding:16px}
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media(max-width:860px){.grid-2,.grid-3{grid-template-columns:1fr}}
    input,select,button,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--pri);box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    button{cursor:pointer;transition:.15s}
    .btn{background:var(--pri);color:#fff;border-color:transparent}
    .btn:hover{filter:brightness(.95)}
    .btn-ok{background:var(--ok)}
    .btn-warn{background:var(--warn)}
    .btn-bad{background:var(--bad)}
    .btn-ghost{background:#fff;border:1px solid #e5e7eb;color:#111}
    .row{display:flex;gap:8px;align-items:center}
    .row.wrap{flex-wrap:wrap}
    .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}.mt20{margin-top:20px}
    .title{font-weight:700;margin:0 0 8px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #f1f5f9;padding:8px 10px;text-align:left}
    thead th{background:#f8fafc;font-size:13px;color:#334155}
    tfoot td{font-weight:700}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .chip{display:inline-flex;align-items:center;gap:6px;background:#f1f5f9;border:1px solid #e5e7eb;border-radius:999px;padding:4px 10px;font-size:12px}
    section{display:none}
    section.active{display:block}
    .login{max-width:400px;margin:8vh auto}
    .brand{font-size:22px;font-weight:800;margin-bottom:8px}
    #printArea{display:none}
    @media print{ body *{visibility:hidden} #printArea, #printArea *{visibility:visible} #printArea{position:absolute;left:0;top:0;width:58mm;padding:6px;font-family:monospace;font-size:12px;background:#fff} #printArea h3,#printArea p{margin:0 0 6px} #printArea table{width:100%} #printArea th,#printArea td{border:none;padding:2px 0;font-size:12px} }
  </style>
</head>
<body>
  <header>
    <h1>Toko Bangunan Najar Putra</h1>
    <div class="row">
      <span class="chip"><span id="loginState">Belum login</span></span>
      <button id="btnLogout" class="btn-bad" style="display:none" onclick="logout()">Logout</button>
    </div>
  </header>

  <div class="wrap">
    <!-- LOGIN -->
    <section id="sec-login" class="active">
      <div class="card p16 login">
        <div class="brand">Masuk Kasir</div>
        <div class="grid">
          <input id="inUser" placeholder="Username" />
          <input id="inPass" type="password" placeholder="Password" />
          <button class="btn" onclick="login()">Login</button>
        </div>
      </div>
    </section>

    <!-- MENU -->
    <section id="sec-menu">
      <div class="card p16">
        <h2 class="title">Menu</h2>
        <div class="grid grid-3">
          <button class="btn" onclick="go('sec-in')">üì¶ Data Barang Masuk</button>
          <button class="btn" onclick="go('sec-out')">üì§ Data Barang Keluar</button>
          <button class="btn" onclick="go('sec-pos')">üßæ Transaksi Kasir</button>
          <button class="btn" onclick="go('sec-sales')">üìö Daftar Transaksi</button>
          <button class="btn" onclick="go('sec-opname')">üìä Stok Opname</button>
          <button class="btn btn-ghost" onclick="go('sec-products')">üóÇÔ∏è Master Produk</button>
        </div>
      </div>
    </section>

    <!-- MASTER PRODUK -->
    <section id="sec-products">
      <div class="card p16">
        <div class="row wrap" style="justify-content:space-between">
          <h2 class="title">Master Produk</h2>
          <button class="btn btn-ghost" onclick="go('sec-menu')">‚¨Ö Kembali</button>
        </div>
        <div class="grid grid-3 mt12">
          <input id="pName" placeholder="Nama produk" />
          <input id="pSku" placeholder="SKU / Barcode (opsional)" />
          <input id="pPrice" type="number" placeholder="Harga Jual" />
        </div>
        <div class="row mt8">
          <button class="btn-ok" onclick="addOrUpdateProduct()">Tambah / Update</button>
          <input id="pSearch" placeholder="Cari produk..." oninput="renderProducts()" />
        </div>
        <div class="mt16">
          <table>
            <thead><tr><th>Nama</th><th>SKU</th><th class="right">Harga</th><th class="right">Stok</th><th>Aksi</th></tr></thead>
            <tbody id="tblProducts"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- BARANG MASUK -->
    <section id="sec-in">
      <div class="card p16">
        <div class="row wrap" style="justify-content:space-between">
          <h2 class="title">Barang Masuk</h2>
          <button class="btn btn-ghost" onclick="go('sec-menu')">‚¨Ö Kembali</button>
        </div>
        <div class="grid grid-3 mt12">
          <select id="inProd"></select>
          <input id="inQty" type="number" placeholder="Qty" />
          <input id="inNote" placeholder="Catatan (No. Nota / Supplier)" />
        </div>
        <div class="row mt8">
          <button class="btn-ok" onclick="stockIn()">Tambahkan</button>
          <button class="btn-ghost" onclick="openNewProductFrom('inProd')">+ Produk baru</button>
        </div>
        <div class="mt16">
          <table>
            <thead><tr><th>Tgl</th><th>Produk</th><th class="right">Qty</th><th>Catatan</th></tr></thead>
            <tbody id="tblIn"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- BARANG KELUAR -->
    <section id="sec-out">
      <div class="card p16">
        <div class="row wrap" style="justify-content:space-between">
          <h2 class="title">Barang Keluar / Penyesuaian</h2>
          <button class="btn btn-ghost" onclick="go('sec-menu')">‚¨Ö Kembali</button>
        </div>
        <div class="grid grid-3 mt12">
          <select id="outProd"></select>
          <input id="outQty" type="number" placeholder="Qty" />
          <input id="outNote" placeholder="Alasan (rusak / hilang / lainnya)" />
        </div>
        <div class="row mt8">
          <button class="btn-warn" onclick="stockOut()">Kurangi</button>
          <button class="btn-ghost" onclick="openNewProductFrom('outProd')">+ Produk baru</button>
        </div>
        <div class="mt16">
          <table>
            <thead><tr><th>Tgl</th><th>Produk</th><th class="right">Qty</th><th>Alasan</th></tr></thead>
            <tbody id="tblOut"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- POS / TRANSAKSI KASIR -->
    <section id="sec-pos">
      <div class="card p16">
        <div class="row wrap" style="justify-content:space-between">
          <h2 class="title">Transaksi Kasir</h2>
          <button class="btn btn-ghost" onclick="go('sec-menu')">‚¨Ö Kembali</button>
        </div>
        <div class="grid grid-3 mt12">
          <select id="posProd"></select>
          <input id="posPrice" type="number" placeholder="Harga" />
          <div class="row">
            <input id="posQty" type="number" placeholder="Qty" />
            <button class="btn-ok" onclick="addToCart()">Tambah</button>
          </div>
        </div>
        <div class="mt16">
          <table>
            <thead><tr><th>Produk</th><th class="right">Harga</th><th class="right">Qty</th><th class="right">Subtotal</th><th></th></tr></thead>
            <tbody id="tblCart"></tbody>
            <tfoot><tr><td colspan="3" class="right">Total</td><td class="right" id="cartTotal">0</td><td></td></tr></tfoot>
          </table>
          <div class="grid grid-3 mt12">
            <input id="payCash" type="number" placeholder="Tunai diterima" />
            <input id="payNote" placeholder="Catatan (opsional)" />
            <button class="btn" onclick="checkout()">Bayar & Cetak</button>
          </div>
        </div>
      </div>
    </section>

    <!-- DAFTAR TRANSAKSI -->
    <section id="sec-sales">
      <div class="card p16">
        <div class="row wrap" style="justify-content:space-between">
          <h2 class="title">Daftar Transaksi</h2>
          <button class="btn btn-ghost" onclick="go('sec-menu')">‚¨Ö Kembali</button>
        </div>
        <div class="grid grid-3 mt12">
          <input id="sFrom" type="date" />
          <input id="sTo" type="date" />
          <button class="btn-ghost" onclick="renderSales()">Filter</button>
        </div>
        <div class="mt16">
          <table>
            <thead><tr><th>Waktu</th><th>ID</th><th class="right">Item</th><th class="right">Total</th><th>Kasir</th><th>Aksi</th></tr></thead>
            <tbody id="tblSales"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- STOK OPNAME -->
    <section id="sec-opname">
      <div class="card p16">
        <div class="row wrap" style="justify-content:space-between">
          <h2 class="title">Stok Opname</h2>
          <button class="btn btn-ghost" onclick="go('sec-menu')">‚¨Ö Kembali</button>
        </div>
        <div class="mt12">
          <table>
            <thead><tr><th>Produk</th><th class="right">Stok Sistem</th><th class="right">Stok Hitung</th></tr></thead>
            <tbody id="tblOpname"></tbody>
          </table>
          <div class="row mt12">
            <button class="btn" onclick="applyOpname()">Terapkan Opname</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- PRINT AREA -->
  <div id="printArea">
    <h3 style="text-align:center">TOKO BANGUNAN</h3>
    <p style="text-align:center">Jl. Contoh 123 ¬∑ 0812-3456-7890</p>
    <p id="prnMeta"></p>
    <table>
      <thead><tr><th>Item</th><th class="right">Qty</th><th class="right">Harga</th><th class="right">Sub</th></tr></thead>
      <tbody id="prnBody"></tbody>
    </table>
    <hr />
    <table>
      <tbody>
        <tr><td><b>Total</b></td><td class="right" id="prnTotal"></td></tr>
        <tr><td>Tunai</td><td class="right" id="prnCash"></td></tr>
        <tr><td>Kembali</td><td class="right" id="prnChange"></td></tr>
      </tbody>
    </table>
    <p style="text-align:center">Terima kasih üôè</p>
  </div>

  <!-- FIREBASE + APP LOGIC -->
 <script type="module"> // --- Import Firebase --- 
   import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"; import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js"; // --- Konfigurasi Firebase (ganti dengan punyamu) --- 
   const firebaseConfig = { apiKey: "AIzaSyAJexdQUpqkeg24nAPJ1rv76f62DhZmu2g", authDomain: "kasirnajarputra-6731e.firebaseapp.com", projectId: "kasirnajarputra-6731e", storageBucket: "kasirnajarputra-6731e.firebasestorage.app", messagingSenderId: "271162396307", appId: "1:271162396307:web:5d07b2d2b05fe037420766", measurementId: "G-8LSYG7VBQ5" }; const app = initializeApp(firebaseConfig); const db = getFirestore(app); 
   // --- Login Logic --- 
   const loginForm = document.getElementById("loginForm"); loginForm.addEventListener("submit", async (e) => { e.preventDefault(); const username = document.getElementById("username").value.trim(); const password = document.getElementById("password").value.trim(); const q = query(collection(db, "users"), where("username", "==", username), where("password", "==", password)); const querySnapshot = await getDocs(q); if (!querySnapshot.empty) { 
     // login sukses 
     document.getElementById("loginPage").classList.add("hidden"); document.getElementById("menuPage").classList.remove("hidden"); } else { alert("‚ùå Username atau password salah!"); } });

    // ---------- Utils ----------
    const fmt = n => Number(n||0).toLocaleString('id-ID');
    const uid = (p='TX') => p + Math.random().toString(36).slice(2,8).toUpperCase();
    const nowISO = () => new Date().toISOString();

    // local session
    const store = {
      get(k,d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d } catch(e){ return d } },
      set(k,v){ localStorage.setItem(k, JSON.stringify(v)) }
    };

    // ---------- UI state ----------
    let session = store.get('session', null);
    function setLoginState(){
      const el = document.getElementById('loginState');
      const btn = document.getElementById('btnLogout');
      if(session){ el.textContent = `Login: ${session.name}`; btn.style.display='inline-flex'; }
      else { el.textContent = 'Belum login'; btn.style.display='none'; }
    }

    // ---------- NAV ----------
    function go(id){
      document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      // refresh data when buka halaman
      if(id==='sec-products') renderProducts();
      if(id==='sec-in'){ awaitFillProducts('inProd'); renderIn(); }
      if(id==='sec-out'){ awaitFillProducts('outProd'); renderOut(); }
      if(id==='sec-pos'){ awaitFillProducts('posProd'); resetCartUI(); }
      if(id==='sec-sales') renderSales();
      if(id==='sec-opname') renderOpname();
      window.scrollTo(0,0);
    }

    // small helper for calling async in go above
    async function awaitFillProducts(selId){ await fillProductSelect(selId); if(selId==='posProd'){ const priceEl=document.getElementById('posPrice'); const sel=document.getElementById('posProd'); priceEl.value = Number(sel.selectedOptions[0]?.dataset.price||0);} }

    // ---------- AUTH ----------
    async function login(){
      const u = document.getElementById('inUser').value.trim();
      const p = document.getElementById('inPass').value.trim();
      if(!u || !p){ alert('Username & password wajib'); return; }

      // try Firestore users collection
      try {
        const q = query(collection(db,'users'), where('u','==',u), where('p','==',p));
        const snap = await getDocs(q);
        if(!snap.empty){
          const docu = snap.docs[0].data();
          session = {u: docu.u, name: docu.name || docu.u, ts: nowISO()};
          store.set('session', session); setLoginState();
          document.getElementById('sec-login').classList.remove('active');
          document.getElementById('sec-menu').classList.add('active');
          return;
        }
      } catch(e){
        console.error(e);
      }

    function logout(){ session=null; localStorage.removeItem('session'); setLoginState(); go('sec-login'); }

    // ---------- PRODUCTS ----------
    async function renderProducts(){
      const qText = (document.getElementById('pSearch').value||'').toLowerCase();
      const tbody = document.getElementById('tblProducts');
      tbody.innerHTML = `<tr><td colspan="5" class="muted">Memuat...</td></tr>`;
      try {
        const snap = await getDocs(collection(db,'products'));
        let list = snap.docs.map(d=>({id:d.id, ...d.data()}));
        if(qText) list = list.filter(p=> (p.name||'').toLowerCase().includes(qText) || (p.sku||'').toLowerCase().includes(qText));
        if(list.length===0) { tbody.innerHTML = `<tr><td colspan='5' class='muted'>Belum ada data</td></tr>`; return; }
        tbody.innerHTML = list.map(p=>`<tr>
          <td>${p.name}</td>
          <td>${p.sku||''}</td>
          <td class='right'>${fmt(p.price)}</td>
          <td class='right'>${fmt(p.stock||0)}</td>
          <td class='row'><button class='btn-ghost' onclick="editProduct('${p.id}')">Edit</button>
              <button class='btn-bad' onclick="deleteProduct('${p.id}')">Hapus</button></td>
        </tr>`).join('');
      } catch(e){
        console.error(e); tbody.innerHTML = `<tr><td colspan='5' class='muted'>Gagal memuat produk</td></tr>`;
      }
    }

    // add or update product (if id exists in hidden field)
    let editingProductId = null;
    async function addOrUpdateProduct(){
      const name = document.getElementById('pName').value.trim();
      const sku = document.getElementById('pSku').value.trim();
      const price = Number(document.getElementById('pPrice').value||0);
      if(!name) { alert('Nama produk wajib'); return; }
      try {
        if(editingProductId){
          await updateDoc(doc(db,'products',editingProductId), { name, sku, price });
          editingProductId = null;
        } else {
          // try to find existing by sku or name
          if(sku){
            const q = query(collection(db,'products'), where('sku','==',sku));
            const snap = await getDocs(q);
            if(!snap.empty){
              const id = snap.docs[0].id;
              await updateDoc(doc(db,'products',id), { name, sku, price });
              renderProducts(); clearProductInputs();
              alert('Produk diperbarui (berdasarkan SKU)');
              return;
            }
          }
          // else create new
          await addDoc(collection(db,'products'), { name, sku, price, stock: 0, createdAt: serverTimestamp() });
        }
        renderProducts(); clearProductInputs(); alert('Produk disimpan');
      } catch(e){
        console.error(e); alert('Gagal menyimpan produk');
      }
    }
    function clearProductInputs(){ document.getElementById('pName').value=''; document.getElementById('pSku').value=''; document.getElementById('pPrice').value=''; editingProductId = null; }

    async function editProduct(id){
      try{
        const d = await getDoc(doc(db,'products',id));
        if(!d.exists()) return alert('Produk tidak ditemukan');
        const p = d.data();
        document.getElementById('pName').value = p.name||'';
        document.getElementById('pSku').value = p.sku||'';
        document.getElementById('pPrice').value = p.price||0;
        editingProductId = id;
        window.scrollTo(0,0);
      }catch(e){ console.error(e); }
    }
    async function deleteProduct(id){
      if(!confirm('Hapus produk ini?')) return;
      try { await deleteDoc(doc(db,'products',id)); renderProducts(); alert('Produk dihapus'); }
      catch(e){ console.error(e); alert('Gagal menghapus produk'); }
    }

    // fill select with products
    async function fillProductSelect(selId){
      const sel = document.getElementById(selId);
      sel.innerHTML = `<option value=''>Memuat...</option>`;
      try{
        const snap = await getDocs(collection(db,'products'));
        const list = snap.docs.map(d=>({id:d.id, ...d.data()}));
        if(list.length===0){ sel.innerHTML = `<option value=''>Belum ada produk</option>`; return; }
        sel.innerHTML = list.map(p=>`<option value='${p.id}' data-price='${p.price||0}'>${p.name}</option>`).join('');
        if(selId==='posProd'){
          const priceEl = document.getElementById('posPrice');
          sel.onchange = () => { priceEl.value = Number(sel.selectedOptions[0]?.dataset.price||0) };
          priceEl.value = Number(sel.selectedOptions[0]?.dataset.price||0);
        }
      }catch(e){ console.error(e); sel.innerHTML = `<option value=''>Gagal memuat</option>`; }
    }
    function openNewProductFrom(backSel){ go('sec-products'); setTimeout(()=>document.getElementById('pName').focus(),200); }

    // ---------- STOCK IN ----------
    async function stockIn(){
      const pid = document.getElementById('inProd').value; if(!pid) return alert('Pilih produk');
      const qty = Number(document.getElementById('inQty').value||0); if(qty<=0) return alert('Qty > 0');
      const note = document.getElementById('inNote').value||'';
      try{
        // transaction: add stockIn doc and update product stock
        await addDoc(collection(db,'stockIn'), { pid, qty, note, ts: serverTimestamp() });
        // update product stock (safe with transaction)
        await runTransaction(db, async (t) => {
          const pRef = doc(db,'products',pid);
          const pDoc = await t.get(pRef);
          if(!pDoc.exists()) throw "Produk tidak ditemukan";
          const newStock = (pDoc.data().stock||0) + qty;
          t.update(pRef, { stock: newStock });
        });
        document.getElementById('inQty').value=''; document.getElementById('inNote').value='';
        renderIn(); alert('Barang masuk dicatat');
      }catch(e){ console.error(e); alert('Gagal mencatat barang masuk'); }
    }
    async function renderIn(){
      const tbody = document.getElementById('tblIn'); tbody.innerHTML = `<tr><td colspan='4' class='muted'>Memuat...</td></tr>`;
      try{
        const snap = await getDocs(query(collection(db,'stockIn'), orderBy('ts','desc')));
        const prodsSnap = await getDocs(collection(db,'products'));
        const prods = Object.fromEntries(prodsSnap.docs.map(d=>[d.id,d.data()]));
        if(snap.empty){ tbody.innerHTML = `<tr><td colspan='4' class='muted'>Belum ada data</td></tr>`; return; }
        tbody.innerHTML = snap.docs.map(d=>{
          const r = d.data();
          const name = prods[r.pid]?.name || '?';
          const ts = r.ts && r.ts.toDate ? r.ts.toDate().toLocaleString('id-ID') : '-';
          return `<tr><td>${ts}</td><td>${name}</td><td class='right'>${fmt(r.qty)}</td><td>${r.note||''}</td></tr>`;
        }).join('');
      }catch(e){ console.error(e); tbody.innerHTML = `<tr><td colspan='4' class='muted'>Gagal memuat</td></tr>`; }
    }

    // ---------- STOCK OUT ----------
    async function stockOut(){
      const pid = document.getElementById('outProd').value; if(!pid) return alert('Pilih produk');
      const qty = Number(document.getElementById('outQty').value||0); if(qty<=0) return alert('Qty > 0');
      const note = document.getElementById('outNote').value||'';
      try{
        // check stock and run transaction
        await runTransaction(db, async (t) => {
          const pRef = doc(db,'products',pid);
          const pDoc = await t.get(pRef);
          if(!pDoc.exists()) throw "Produk tidak ditemukan";
          const cur = pDoc.data().stock||0;
          if(cur < qty) throw "Stok tidak cukup";
          t.update(pRef, { stock: cur - qty });
        });
        await addDoc(collection(db,'stockOut'), { pid, qty, note, ts: serverTimestamp() });
        document.getElementById('outQty').value=''; document.getElementById('outNote').value='';
        renderOut(); alert('Barang keluar dicatat');
      }catch(e){ console.error(e); alert(typeof e === 'string' ? e : 'Gagal mencatat barang keluar'); }
    }
    async function renderOut(){
      const tbody = document.getElementById('tblOut'); tbody.innerHTML = `<tr><td colspan='4' class='muted'>Memuat...</td></tr>`;
      try{
        const snap = await getDocs(query(collection(db,'stockOut'), orderBy('ts','desc')));
        const prodsSnap = await getDocs(collection(db,'products'));
        const prods = Object.fromEntries(prodsSnap.docs.map(d=>[d.id,d.data()]));
        if(snap.empty){ tbody.innerHTML = `<tr><td colspan='4' class='muted'>Belum ada data</td></tr>`; return; }
        tbody.innerHTML = snap.docs.map(d=>{
          const r = d.data();
          const name = prods[r.pid]?.name || '?';
          const ts = r.ts && r.ts.toDate ? r.ts.toDate().toLocaleString('id-ID') : '-';
          return `<tr><td>${ts}</td><td>${name}</td><td class='right'>${fmt(r.qty)}</td><td>${r.note||''}</td></tr>`;
        }).join('');
      }catch(e){ console.error(e); tbody.innerHTML = `<tr><td colspan='4' class='muted'>Gagal memuat</td></tr>`; }
    }

    // ---------- POS / CART / CHECKOUT ----------
    let cart = [];
    function resetCartUI(){ cart=[]; renderCart(); document.getElementById('payCash').value=''; document.getElementById('payNote').value=''; document.getElementById('posQty').value=''; }
    function addToCart(){
      const pid = document.getElementById('posProd').value; if(!pid) return alert('Pilih produk');
      const price = Number(document.getElementById('posPrice').value||0);
      const qty = Number(document.getElementById('posQty').value||0); if(qty<=0) return alert('Qty > 0');
      const name = document.getElementById('posProd').selectedOptions[0].textContent;
      cart.push({ pid, name, price, qty, sub: price * qty });
      renderCart(); document.getElementById('posQty').value='';
    }
    function removeCart(i){ cart.splice(i,1); renderCart(); }
    function renderCart(){
      const rows = cart.map((c,i)=>`<tr><td>${c.name}</td><td class='right'>${fmt(c.price)}</td><td class='right'>${fmt(c.qty)}</td><td class='right'>${fmt(c.sub)}</td><td><button class='btn-ghost' onclick='removeCart(${i})'>Hapus</button></td></tr>`).join('');
      document.getElementById('tblCart').innerHTML = rows || `<tr><td colspan='5' class='muted'>Belum ada item</td></tr>`;
      const tot = cart.reduce((a,b)=>a+b.sub,0); document.getElementById('cartTotal').textContent = fmt(tot);
    }

    async function checkout(){
      if(cart.length===0) return alert('Keranjang kosong');
      if(!session) return alert('Harus login');
      const cash = Number(document.getElementById('payCash').value||0);
      const note = document.getElementById('payNote').value||'';
      const total = cart.reduce((a,b)=>a+b.sub,0);
      if(cash < total) return alert('Tunai kurang');

      // transaction: cek stok & update product stocks, lalu simpan transaksi
      try{
        // run one big transaction that checks & updates stocks (but transactions can't write to multiple collections arbitrarily in some cases; we will update product stocks inside transaction, then add sale doc outside)
        await runTransaction(db, async (t) => {
          for(const it of cart){
            const pRef = doc(db,'products',it.pid);
            const pDoc = await t.get(pRef);
            if(!pDoc.exists()) throw `Produk ${it.name} tidak ditemukan`;
            const cur = pDoc.data().stock || 0;
            if(cur < it.qty) throw `Stok tidak cukup untuk ${it.name}`;
            t.update(pRef, { stock: cur - it.qty });
          }
        });

        // simpan transaksi (sale)
        await addDoc(collection(db,'sales'), {
          id: uid('SALE'),
          ts: serverTimestamp(),
          cashier: session.name,
          total,
          items: cart,
          note
        });

        // simpan juga ke koleksi stockOut per item (opsional): kita buat catatan keluar dari penjualan
        for(const it of cart){
          await addDoc(collection(db,'stockOut'), { pid: it.pid, qty: it.qty, note: `Sale ${session.name}`, ts: serverTimestamp() });
        }

        printSale({ items: cart, total, cashier: session.name, id: '---' }, cash);
        resetCartUI();
        alert('Transaksi berhasil');
      }catch(e){
        console.error(e);
        alert(typeof e === 'string' ? e : 'Gagal melakukan checkout (mungkin stok berubah). Coba refresh produk.');
      }
    }

    function printSale(sale, cash){
      const body = document.getElementById('prnBody');
      body.innerHTML = sale.items.map(it=>`<tr><td>${it.name}</td><td class='right'>${fmt(it.qty)}</td><td class='right'>${fmt(it.price)}</td><td class='right'>${fmt(it.sub)}</td></tr>`).join('');
      document.getElementById('prnMeta').textContent = `${new Date().toLocaleString('id-ID')} ¬∑ Kasir: ${sale.cashier} ¬∑ ID: ${sale.id}`;
      document.getElementById('prnTotal').textContent = fmt(sale.total);
      document.getElementById('prnCash').textContent = fmt(cash);
      document.getElementById('prnChange').textContent = fmt(cash - sale.total);
      window.print();
    }

    // ---------- SALES LIST ----------
    async function renderSales(){
      const tbody = document.getElementById('tblSales'); tbody.innerHTML = `<tr><td colspan='6' class='muted'>Memuat...</td></tr>`;
      try{
        const snap = await getDocs(query(collection(db,'sales'), orderBy('ts','desc')));
        if(snap.empty){ tbody.innerHTML = `<tr><td colspan='6' class='muted'>Belum ada transaksi</td></tr>`; return; }
        const rows = snap.docs.map(d=>{
          const s = d.data();
          const ts = s.ts && s.ts.toDate ? s.ts.toDate().toLocaleString('id-ID') : '-';
          const id = s.id || d.id;
          const items = (s.items || []).length;
          return `<tr>
            <td>${ts}</td>
            <td>${id}</td>
            <td class='right'>${fmt(items)}</td>
            <td class='right'>${fmt(s.total)}</td>
            <td>${s.cashier||''}</td>
            <td class='row'>
              <button class='btn-ghost' onclick="reprint('${d.id}')">Cetak</button>
              <button class='btn-bad' onclick="removeSale('${d.id}')">Hapus</button>
            </td>
          </tr>`;
        }).join('');
        tbody.innerHTML = rows;
      }catch(e){ console.error(e); tbody.innerHTML = `<tr><td colspan='6' class='muted'>Gagal memuat</td></tr>`; }
    }
    async function reprint(docId){
      try{
        const d = await getDoc(doc(db,'sales',docId));
        if(!d.exists()) return alert('Data transaksi tidak ditemukan');
        const s = d.data();
        printSale({ items: s.items, total: s.total, cashier: s.cashier, id: s.id||docId }, s.total);
      }catch(e){ console.error(e); alert('Gagal reprint'); }
    }
    async function removeSale(docId){
      if(!confirm('Hapus transaksi ini? Stok TIDAK otomatis kembali.')) return;
      try{ await deleteDoc(doc(db,'sales',docId)); renderSales(); alert('Dihapus'); }catch(e){ console.error(e); alert('Gagal menghapus'); }
    }

    // ---------- OPNAME ----------
    async function renderOpname(){
      const tbody = document.getElementById('tblOpname'); tbody.innerHTML = `<tr><td colspan='3' class='muted'>Memuat...</td></tr>`;
      try{
        const snap = await getDocs(query(collection(db,'products'), orderBy('name')));
        if(snap.empty){ tbody.innerHTML = `<tr><td colspan='3' class='muted'>Belum ada produk</td></tr>`; return; }
        tbody.innerHTML = snap.docs.map(d=>{
          const p = d.data();
          return `<tr>
            <td>${p.name}</td>
            <td class='right'>${fmt(p.stock||0)}</td>
            <td class='right'><input style='width:120px' type='number' id='op_${d.id}' placeholder='Hitung' /></td>
          </tr>`;
        }).join('');
      }catch(e){ console.error(e); tbody.innerHTML = `<tr><td colspan='3' class='muted'>Gagal memuat</td></tr>`; }
    }

    async function applyOpname(){
      try{
        const prodsSnap = await getDocs(collection(db,'products'));
        let adjCount = 0;
        for(const d of prodsSnap.docs){
          const p = d.data();
          const el = document.getElementById('op_'+d.id);
          if(!el) continue;
          const counted = el.value === '' ? null : Number(el.value);
          if(counted === null || isNaN(counted)) continue;
          const diff = counted - (p.stock||0);
          if(diff === 0) continue;
          if(diff > 0){
            await addDoc(collection(db,'stockIn'), { pid: d.id, qty: diff, note: 'Opname (+)', ts: serverTimestamp() });
          } else {
            await addDoc(collection(db,'stockOut'), { pid: d.id, qty: Math.abs(diff), note: 'Opname (-)', ts: serverTimestamp() });
          }
          await updateDoc(doc(db,'products',d.id), { stock: counted });
          adjCount++;
        }
        if(adjCount === 0) alert('Tidak ada perubahan opname');
        else { alert('Opname diterapkan ke '+adjCount+' produk'); renderOpname(); }
      }catch(e){ console.error(e); alert('Gagal menerapkan opname'); }
    }

    // ---------- INIT ----------
    setLoginState();
    // if session exist, auto show menu
    if(store.get('session')){ session = store.get('session'); setLoginState(); document.getElementById('sec-login').classList.remove('active'); document.getElementById('sec-menu').classList.add('active'); }

    // expose for HTML onclick usage
    window.go = go;
    window.login = login;
    window.logout = logout;
    window.addOrUpdateProduct = addOrUpdateProduct;
    window.editProduct = editProduct;
    window.deleteProduct = deleteProduct;
    window.fillProductSelect = fillProductSelect;
    window.openNewProductFrom = openNewProductFrom;
    window.stockIn = stockIn;
    window.stockOut = stockOut;
    window.addToCart = addToCart;
    window.resetCartUI = resetCartUI;
    window.checkout = checkout;
    window.renderSales = renderSales;
    window.reprint = reprint;
    window.removeSale = removeSale;
    window.renderOpname = renderOpname;
    window.applyOpname = applyOpname;
    window.renderIn = renderIn;
    window.renderOut = renderOut;
    window.renderProducts = renderProducts;

    // when entering product-dependent pages, fill selects
    document.addEventListener('visibilitychange', ()=>{ /* nothing */ });

    // initial preload for some pages (not blocking)
    (async ()=>{
      await renderProducts();
      await fillProductSelect('inProd');
      await fillProductSelect('outProd');
      await fillProductSelect('posProd');
      await renderIn(); await renderOut(); await renderOpname(); await renderSales();
    })();

  </script>
</body>
</html>


