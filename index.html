<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Toko Bangunan Najar Putra</title>
  <style>   
    :root{--bg:#f6f7fb;--card:#ffffff;--pri:#2563eb;--ok:#16a34a;--warn:#ea580c;--bad:#dc2626;--muted:#6b7280}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;background:var(--bg);color:#111}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--card);border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:10}
    header h1{font-size:18px;margin:0}
    header .user{font-size:14px;color:var(--muted)}
    .wrap{max-width:1050px;margin:18px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.04)}
    .p16{padding:16px}
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    @media(max-width:860px){.grid-2,.grid-3,.grid-4{grid-template-columns:1fr}}
    input,select,button,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--pri);box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    button{cursor:pointer;transition:.15s}
    .btn{background:var(--pri);color:#fff;border-color:transparent}
    .btn:hover{filter:brightness(.95)}
    .btn-ok{background:var(--ok)}
    .btn-warn{background:var(--warn)}
    .btn-bad{background:var(--bad)}
    .btn-ghost{background:#fff;border:1px solid #e5e7eb;color:#111}
    .row{display:flex;gap:8px;align-items:center}
    .row.wrap{flex-wrap:wrap}
    .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}.mt20{margin-top:20px}
    .title{font-weight:700;margin:0 0 8px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #f1f5f9;padding:8px 10px;text-align:left}
    thead th{background:#f8fafc;font-size:13px;color:#334155}
    tfoot td{font-weight:700}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .chip{display:inline-flex;align-items:center;gap:6px;background:#f1f5f9;border:1px solid #e5e7eb;border-radius:999px;padding:4px 10px;font-size:12px}   
    footer {
      background: #eee;
      text-align: center;
      padding: 10px;
      font-size: 14px;
      color: #555;
    }

    /* sections */
    section{display:none}
    section.active{display:block}

    /* login */
    .login{max-width:400px;margin:8vh auto}
    .brand{font-size:22px;font-weight:800;margin-bottom:8px}

    /* payment summary */
    .payment-summary{background:#f8fafc;border:1px solid #e5e7eb;border-radius:10px;padding:16px;margin-top:12px}
    .payment-row{display:flex;justify-content:space-between;align-items:center;margin:8px 0}
    .payment-value{font-weight:600}
    .total-row{border-top:2px solid #e5e7eb;padding-top:12px;margin-top:12px;font-size:18px;font-weight:700}
    .change-display{background:#dcfce7;border:1px solid #bbf7d0;color:#166534;font-size:16px;font-weight:700;text-align:center;padding:12px;border-radius:8px;margin:8px 0}

    /* print styles for thermal receipt */
    #printArea{display:none}
    @media print{
      body *{visibility:hidden}
      #printArea, #printArea *{visibility:visible}
      #printArea{position:absolute;left:0;top:0;width:58mm;/* ganti ke 80mm jika printer 80mm */ padding:6px;font-family:monospace;font-size:12px;background:#fff}
      #printArea h3,#printArea p{margin:0 0 6px}
      #printArea table{width:100%}
      #printArea th,#printArea td{border:none;padding:2px 0;font-size:12px}
    }
  </style>
</head>
<body>
  <header>
    <img src="logonajar.png" alt="Logo Toko Najar Putra" width="100">
    <div class="row">
      <span class="chip"><span id="loginState">Belum login</span></span>
      <button id="btnLogout" class="btn-bad" style="display:none" onclick="logout()">Logout</button>
    </div>
  </header>
  

  <div class="wrap">

    <!-- LOGIN -->
    <section id="sec-login" class="active">
      <div class="card p16 login">
        <div class="brand">Kasir Toko Najar Putra</div>
        <div class="grid">
          <input id="inUser" placeholder="Username" />
          <input id="inPass" type="password" placeholder="Password" />
          <button class="btn" onclick="login()">Login</button>
        </div>
      </div>
    </section>

    <!-- MENU -->
    <section id="sec-menu">
      <div class="card p16">
        <h2 class="title">Menu</h2>
        <div class="grid grid-3">
          <button class="btn" onclick="go('sec-in')">Data Barang Masuk</button>
          <button class="btn" onclick="go('sec-out')">Data Barang Keluar</button>
          <button class="btn" onclick="go('sec-pos')">Transaksi Kasir</button>
          <button class="btn" onclick="go('sec-sales')">Daftar Transaksi</button>
          <button class="btn" onclick="go('sec-opname')">Stok Opname</button>
          <button class="btn btn-ghost" onclick="go('sec-products')">Master Produk</button>
        </div>
      </div>
    </section>

    <!-- MASTER PRODUK -->
    <section id="sec-products">
      <div class="card p16">
        <div class="row wrap" style="justify-content:space-between">
          <h2 class="title">Master Produk</h2>
        </div>
        <div class="grid grid-3 mt12">
          <input id="pName" placeholder="Nama produk" />
          <input id="pSku" placeholder="SKU / Barcode (opsional)" />
          <input id="pPrice" type="number" placeholder="Harga Jual" />
        </div>
        <div class="row mt8">
          <button class="btn-ok" onclick="addProduct()">Tambah / Update</button>
          <input id="pSearch" placeholder="Cari produk..." oninput="renderProducts()" />
        </div>
        <div class="mt16">
          <table>
            <thead><tr><th>Nama</th><th>SKU</th><th class="right">Harga</th><th class="right">Stok</th><th>Aksi</th></tr></thead>
            <tbody id="tblProducts"></tbody>
          </table>
          <button class="btn btn-ghost" onclick="go('sec-menu')">Kembali</button>
        </div>
      </div>
    </section>

    <!-- BARANG MASUK -->
    <section id="sec-in">
      <div class="card p16">
        <div class="row wrap" style="justify-content:space-between">
          <h2 class="title">Barang Masuk</h2>
        </div>
        <div class="grid grid-3 mt12">
          <select id="inProd"></select>
          <input id="inQty" type="number" placeholder="Qty" />
          <input id="inNote" placeholder="Catatan (No. Nota / Supplier)" />
        </div>
        <div class="row mt8">
          <button class="btn-ok" onclick="stockIn()">Tambahkan</button>
          <button class="btn-ghost" onclick="openNewProductFrom('inProd')">+ Produk baru</button>
        </div>
        <div class="mt16">
          <table>
            <thead><tr><th>Tgl</th><th>Produk</th><th class="right">Qty</th><th>Catatan</th></tr></thead>
            <tbody id="tblIn"></tbody>
          </table>
          <button class="btn btn-ghost" onclick="go('sec-menu')">Kembali</button>
        </div>
      </div>
    </section>

    <!-- BARANG KELUAR (PENYESUAIAN) -->
    <section id="sec-out">
      <div class="card p16">
        <div class="row wrap" style="justify-content:space-between">
          <h2 class="title">Barang Keluar / Penyesuaian</h2>
        </div>
        <div class="grid grid-3 mt12">
          <select id="outProd"></select>
          <input id="outQty" type="number" placeholder="Qty" />
          <input id="outNote" placeholder="Alasan (rusak / hilang / lainnya)" />
        </div>
        <div class="row mt8">
          <button class="btn-warn" onclick="stockOut()">Kurangi</button>
          <button class="btn-ghost" onclick="openNewProductFrom('outProd')">+ Produk baru</button>
        </div>
        <div class="mt16">
          <table>
            <thead><tr><th>Tgl</th><th>Produk</th><th class="right">Qty</th><th>Alasan</th></tr></thead>
            <tbody id="tblOut"></tbody>
          </table>
           <button class="btn btn-ghost" onclick="go('sec-menu')">Kembali</button>
        </div>
      </div>
    </section>

    <!-- POS / TRANSAKSI KASIR -->
    <section id="sec-pos">
      <div class="card p16">
        <div class="row wrap" style="justify-content:space-between">
          <h2 class="title">Transaksi Kasir</h2>
          
        </div>
        <div class="grid grid-3 mt12">
          <select id="posProd"></select>
          <input id="posPrice" type="number" placeholder="Harga" />
          <div class="row">
            <input id="posQty" type="number" placeholder="Qty" />
            <button class="btn-ok" onclick="addToCart()">Tambah</button>
          </div>
        </div>
        <div class="mt16">
          <table>
            <thead><tr><th>Produk</th><th class="right">Harga</th><th class="right">Qty</th><th class="right">Subtotal</th><th></th></tr></thead>
            <tbody id="tblCart"></tbody>
            <tfoot><tr><td colspan="3" class="right">Subtotal</td><td class="right" id="cartSubtotal">0</td><td></td></tr></tfoot>
          </table>
          
          <!-- Payment Summary -->
          <div class="payment-summary">
            <div class="grid grid-4">
              <input id="payDiscount" type="number" placeholder="Diskon (Rp)" oninput="updatePaymentSummary()" />
              <input id="payCash" type="number" placeholder="Tunai diterima" oninput="updatePaymentSummary()" />
              <input id="payNote" placeholder="Catatan (opsional)" />
              <div></div>
            </div>
            
            <div class="payment-row">
              <span>Subtotal:</span>
              <span class="payment-value" id="summarySubtotal">Rp 0</span>
            </div>
            <div class="payment-row">
              <span>Diskon:</span>
              <span class="payment-value" id="summaryDiscount">Rp 0</span>
            </div>
            <div class="payment-row total-row">
              <span>Total Bayar:</span>
              <span class="payment-value" id="summaryTotal">Rp 0</span>
            </div>
            <div class="payment-row">
              <span>Tunai Diterima:</span>
              <span class="payment-value" id="summaryCash">Rp 0</span>
            </div>
            
            <div id="changeDisplay" class="change-display" style="display:none">
              Kembalian: <span id="changeAmount">Rp 0</span>
            </div>
            
            <button class="btn mt12" onclick="checkout()" id="checkoutBtn" disabled>Bayar & Cetak</button>
          </div>
        </div>
      </div>
      <button class="btn btn-ghost" onclick="go('sec-menu')">⬅ Kembali</button>
    </section>

    <!-- DAFTAR TRANSAKSI -->
    <section id="sec-sales">
      <div class="card p16">
        <div class="row wrap" style="justify-content:space-between">
          <h2 class="title">Daftar Transaksi</h2>
        </div>
        <div class="grid grid-3 mt12">
          <input id="sFrom" type="date" />
          <input id="sTo" type="date" />
          <button class="btn-ghost" onclick="renderSales()">Filter</button>
        </div>
        <div class="mt16">
          <table>
            <thead><tr><th>Waktu</th><th>ID</th><th class="right">Item</th><th class="right">Total</th><th>Kasir</th><th>Aksi</th></tr></thead>
            <tbody id="tblSales"></tbody>
          </table>
          <button class="btn btn-ghost" onclick="go('sec-menu')">Kembali</button>
        </div>
      </div>
    </section>

    <!-- STOK OPNAME -->
    <section id="sec-opname">
      <div class="card p16">
        <div class="row wrap" style="justify-content:space-between">
          <h2 class="title">Stok Opname</h2>
        </div>
        <div class="mt12">
          <table>
            <thead><tr><th>Produk</th><th class="right">Stok Sistem</th><th class="right">Stok Hitung</th></tr></thead>
            <tbody id="tblOpname"></tbody>
          </table>
          <div class="row mt12">
            <button class="btn" onclick="applyOpname()">Terapkan Opname</button>
          </div>
        </div>
      </div>
      <button class="btn btn-ghost" onclick="go('sec-menu')">Kembali</button>
    </section>
  </div>

  <!-- PRINT AREA (THERMAL) -->
  <div id="printArea">
    <img src="logonajar.png" alt="Logo Toko Najar Putra" width="100">
    <h3 style="text-align:center">TOKO BANGUNAN NAJAR PUTRA</h3>
    <p style="text-align:center">Jl. Contoh 123 · 0812-3456-7890</p>
    <p id="prnMeta"></p>
    <table>
      <thead><tr><th>Item</th><th class="right">Qty</th><th class="right">Harga</th><th class="right">Sub</th></tr></thead>
      <tbody id="prnBody"></tbody>
    </table>
    <hr />
    <table>
      <tbody>
        <tr><td>Subtotal</td><td class="right" id="prnSubtotal"></td></tr>
        <tr><td>Diskon</td><td class="right" id="prnDiscount"></td></tr>
        <tr><td><b>Total</b></td><td class="right" id="prnTotal"></td></tr>
        <tr><td>Tunai</td><td class="right" id="prnCash"></td></tr>
        <tr><td>Kembali</td><td class="right" id="prnChange"></td></tr>
      </tbody>
    </table>
    <p style="text-align:center">Terima kasih 🙏</p>
  </div>

  <script>
    // === UTIL & STORAGE ===
    const fmt = n => Number(n||0).toLocaleString('id-ID');
    const now = () => new Date().toISOString();
    const uid = (p='TX') => p + Math.random().toString(36).slice(2,8).toUpperCase();

    const store = {
      get(k, d){try{return JSON.parse(localStorage.getItem(k)) ?? d}catch{ return d}},
      set(k, v){localStorage.setItem(k, JSON.stringify(v))}
    }

    // Default seed
    if(!store.get('users')) store.set('users',[{u:'kasir',p:'1234',name:'Kasir Najar Putra'}]);
    if(!store.get('products')) store.set('products',[]);
    if(!store.get('stockIn')) store.set('stockIn',[]);
    if(!store.get('stockOut')) store.set('stockOut',[]);
    if(!store.get('sales')) store.set('sales',[]);

    let session = store.get('session', null);

    function setLoginState(){
      const el = document.getElementById('loginState');
      const btn = document.getElementById('btnLogout');
      if(session){ el.textContent = `Login: ${session.name}`; btn.style.display='inline-flex'; }
      else { el.textContent = 'Belum login'; btn.style.display='none'; }
    }

    // === NAVIGATION ===
    function go(id){
      document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      // refresh dropdowns/tables when entering a page
      if(id==='sec-menu'){}
      if(id==='sec-products') renderProducts();
      if(id==='sec-in'){fillProductSelect('inProd'); renderIn();}
      if(id==='sec-out'){fillProductSelect('outProd'); renderOut();}
      if(id==='sec-pos'){fillProductSelect('posProd'); resetCartUI();}
      if(id==='sec-sales') renderSales();
      if(id==='sec-opname') renderOpname();
      window.scrollTo(0,0);
    }

    // === AUTH ===
    function login(){
      const u = document.getElementById('inUser').value.trim();
      const p = document.getElementById('inPass').value.trim();
      const users = store.get('users',[]);
      const found = users.find(x=>x.u===u && x.p===p);
      if(!found){ alert('Username atau password salah'); return; }
      session = {u:found.u,name:found.name||found.u,ts:now()};
      store.set('session', session);
      setLoginState();
      document.getElementById('sec-login').classList.remove('active');
      document.getElementById('sec-menu').classList.add('active');
    }
    function logout(){ session=null; localStorage.removeItem('session'); setLoginState(); go('sec-login'); }

    // === PRODUCTS ===
    function renderProducts(){
      const q = (document.getElementById('pSearch').value||'').toLowerCase();
      const rows = store.get('products',[])
        .filter(p=>!q || p.name.toLowerCase().includes(q) || (p.sku||'').toLowerCase().includes(q))
        .map(p=>`<tr>
          <td>${p.name}</td>
          <td>${p.sku||''}</td>
          <td class='right'>${fmt(p.price)}</td>
          <td class='right'>${fmt(p.stock||0)}</td>
          <td class='row'><button class='btn-ghost' onclick="editProduct('${p.id}')">Edit</button>
              <button class='btn-bad' onclick="delProduct('${p.id}')">Hapus</button></td>
        </tr>`).join('');
      document.getElementById('tblProducts').innerHTML = rows || `<tr><td colspan='5' class='muted'>Belum ada data</td></tr>`;
    }
    function addProduct(){
      let name = document.getElementById('pName').value.trim();
      let sku  = document.getElementById('pSku').value.trim();
      let price= Number(document.getElementById('pPrice').value||0);
      if(!name){alert('Nama produk wajib');return}
      const list = store.get('products',[]);
      // update if exists by name or sku
      let p = list.find(x=>x.name.toLowerCase()===name.toLowerCase() || (sku && x.sku===sku));
      if(p){ p.name=name; p.sku=sku; p.price=price; }
      else { p={id:uid('PRD'),name,sku,price,stock:0}; list.push(p); }
      store.set('products',list);
      document.getElementById('pName').value=''; document.getElementById('pSku').value=''; document.getElementById('pPrice').value='';
      renderProducts();
      alert('Produk disimpan');
    }
    function editProduct(id){
      const p = store.get('products',[]).find(x=>x.id===id); if(!p) return;
      document.getElementById('pName').value=p.name;
      document.getElementById('pSku').value=p.sku||'';
      document.getElementById('pPrice').value=p.price||0;
      window.scrollTo(0,0);
    }
    function delProduct(id){
      if(!confirm('Hapus produk ini?')) return;
      let list = store.get('products',[]).filter(p=>p.id!==id);
      store.set('products',list); renderProducts();
    }
    function fillProductSelect(selId){
      const sel = document.getElementById(selId);
      const list = store.get('products',[]);
      sel.innerHTML = list.map(p=>`<option value='${p.id}' data-price='${p.price||0}'>${p.name}</option>`).join('');
      // auto fill price when used in POS
      if(selId==='posProd'){
        const priceEl = document.getElementById('posPrice');
        sel.onchange = () => { priceEl.value = Number(sel.selectedOptions[0]?.dataset.price||0) };
        priceEl.value = Number(sel.selectedOptions[0]?.dataset.price||0);
      }
    }
    function openNewProductFrom(backSel){
      go('sec-products');
      setTimeout(()=>document.getElementById('pName').focus(),100);
    }

    // === STOCK IN ===
    function stockIn(){
      const pid = document.getElementById('inProd').value; if(!pid) return alert('Pilih produk');
      const qty = Number(document.getElementById('inQty').value||0); if(qty<=0) return alert('Qty > 0');
      const note= document.getElementById('inNote').value||'';
      const rec = {id:uid('IN'),pid,qty,ts:now(),note};
      const ins = store.get('stockIn',[]); ins.push(rec); store.set('stockIn',ins);
      const prods = store.get('products',[]); const p=prods.find(x=>x.id===pid); if(p){p.stock=(p.stock||0)+qty; store.set('products',prods);} 
      document.getElementById('inQty').value=''; document.getElementById('inNote').value='';
      renderIn(); alert('Barang masuk dicatat');
    }
    function renderIn(){
      const ins = store.get('stockIn',[]).slice().reverse();
      const prods = store.get('products',[]);
      const rows = ins.map(r=>`<tr><td>${new Date(r.ts).toLocaleString('id-ID')}</td><td>${prods.find(p=>p.id===r.pid)?.name||'?'}</td><td class='right'>${fmt(r.qty)}</td><td>${r.note||''}</td></tr>`).join('');
      document.getElementById('tblIn').innerHTML = rows || `<tr><td colspan='4' class='muted'>Belum ada data</td></tr>`;
    }

    // === STOCK OUT ===
    function stockOut(){
      const pid = document.getElementById('outProd').value; if(!pid) return alert('Pilih produk');
      const qty = Number(document.getElementById('outQty').value||0); if(qty<=0) return alert('Qty > 0');
      const note= document.getElementById('outNote').value||'';
      const prods = store.get('products',[]); const p=prods.find(x=>x.id===pid); if(!p) return; if((p.stock||0)<qty) return alert('Stok tidak cukup');
      const rec = {id:uid('OUT'),pid,qty,ts:now(),note};
      const outs = store.get('stockOut',[]); outs.push(rec); store.set('stockOut',outs);
      p.stock = (p.stock||0) - qty; store.set('products',prods);
      document.getElementById('outQty').value=''; document.getElementById('outNote').value='';
      renderOut(); alert('Barang keluar dicatat');
    }
    function renderOut(){
      const outs = store.get('stockOut',[]).slice().reverse();
      const prods = store.get('products',[]);
      const rows = outs.map(r=>`<tr><td>${new Date(r.ts).toLocaleString('id-ID')}</td><td>${prods.find(p=>p.id===r.pid)?.name||'?'}</td><td class='right'>${fmt(r.qty)}</td><td>${r.note||''}</td></tr>`).join('');
      document.getElementById('tblOut').innerHTML = rows || `<tr><td colspan='4' class='muted'>Belum ada data</td></tr>`;
    }

    // === POS ===
    let cart = [];
    function resetCartUI(){ 
      cart=[]; 
      renderCart(); 
      document.getElementById('payCash').value=''; 
      document.getElementById('payNote').value=''; 
      document.getElementById('posQty').value='';
      document.getElementById('payDiscount').value='';
      updatePaymentSummary();
    }
    
    function addToCart(){
      const pid = document.getElementById('posProd').value; if(!pid) return;
      const price = Number(document.getElementById('posPrice').value||0);
      const qty = Number(document.getElementById('posQty').value||0); if(qty<=0) return alert('Qty > 0');
      const p = store.get('products',[]).find(x=>x.id===pid); if(!p) return;
      cart.push({pid,name:p.name,price,qty,sub:price*qty});
      renderCart(); 
      document.getElementById('posQty').value='';
      updatePaymentSummary();
    }
    
    function removeCart(i){ 
      cart.splice(i,1); 
      renderCart(); 
      updatePaymentSummary();
    }
    
    function renderCart(){
      const rows = cart.map((c,i)=>`<tr><td>${c.name}</td><td class='right'>${fmt(c.price)}</td><td class='right'>${fmt(c.qty)}</td><td class='right'>${fmt(c.sub)}</td><td><button class='btn-ghost' onclick='removeCart(${i})'>Hapus</button></td></tr>`).join('');
      document.getElementById('tblCart').innerHTML = rows || `<tr><td colspan='5' class='muted'>Belum ada item</td></tr>`;
      const subtotal = cart.reduce((a,b)=>a+b.sub,0); 
      document.getElementById('cartSubtotal').textContent = fmt(subtotal);
    }
    
    function updatePaymentSummary(){
      const subtotal = cart.reduce((a,b)=>a+b.sub,0);
      const discount = Number(document.getElementById('payDiscount').value||0);
      const total = Math.max(0, subtotal - discount);
      const cash = Number(document.getElementById('payCash').value||0);
      const change = Math.max(0, cash - total);
      
      document.getElementById('summarySubtotal').textContent = 'Rp ' + fmt(subtotal);
      document.getElementById('summaryDiscount').textContent = 'Rp ' + fmt(discount);
      document.getElementById('summaryTotal').textContent = 'Rp ' + fmt(total);
      document.getElementById('summaryCash').textContent = 'Rp ' + fmt(cash);
      
      const changeDisplay = document.getElementById('changeDisplay');
      const changeAmount = document.getElementById('changeAmount');
      const checkoutBtn = document.getElementById('checkoutBtn');
      
      if(cash >= total && total > 0){
        changeDisplay.style.display = 'block';
        changeAmount.textContent = 'Rp ' + fmt(change);
        checkoutBtn.disabled = false;
        checkoutBtn.textContent = 'Bayar & Cetak';
      } else if(cash > 0 && cash < total) {
        changeDisplay.style.display = 'none';
        checkoutBtn.disabled = true;
        checkoutBtn.textContent = 'Tunai Kurang Rp ' + fmt(total - cash);
      } else {
        changeDisplay.style.display = 'none';
        checkoutBtn.disabled = true;
        checkoutBtn.textContent = 'Bayar & Cetak';
      }
    }
    
    function checkout(){
      if(cart.length===0) return alert('Keranjang kosong');
      if(!session) return alert('Harus login');
      
      const subtotal = cart.reduce((a,b)=>a+b.sub,0);
      const discount = Number(document.getElementById('payDiscount').value||0);
      const total = Math.max(0, subtotal - discount);
      const cash = Number(document.getElementById('payCash').value||0);
      const note = document.getElementById('payNote').value||'';
      
      if(cash < total) return alert('Tunai kurang');
      
      const prods = store.get('products',[]);
      // cek stok cukup
      for(const it of cart){ 
        const p=prods.find(x=>x.id===it.pid); 
        if(!p|| (p.stock||0)<it.qty) return alert('Stok tidak cukup untuk '+it.name) 
      }
      
      // kurangi stok
      for(const it of cart){ 
        const p=prods.find(x=>x.id===it.pid); 
        p.stock -= it.qty; 
      }
      store.set('products',prods);
      
      // simpan transaksi
      const sale = {
        id:uid('SALE'),
        ts:now(),
        cashier:session.name,
        subtotal,
        discount,
        total,
        items:cart,
        note,
        cash
      };
      const sales = store.get('sales',[]); 
      sales.push(sale); 
      store.set('sales',sales);
      
      // cetak
      printSale(sale);
      
      // reset UI
      resetCartUI();
      alert('Transaksi berhasil');
    }
    
    
    function printSale(sale){
      const body = document.getElementById('prnBody');
      body.innerHTML = sale.items.map(it=>`<tr><td>${it.name}</td><td class='right'>${fmt(it.qty)}</td><td class='right'>${fmt(it.price)}</td><td class='right'>${fmt(it.sub)}</td></tr>`).join('');
      document.getElementById('prnMeta').textContent = `${new Date(sale.ts).toLocaleString('id-ID')} · Kasir: ${sale.cashier} · ID: ${sale.id}`;
      document.getElementById('prnSubtotal').textContent = fmt(sale.subtotal);
      document.getElementById('prnDiscount').textContent = fmt(sale.discount || 0);
      document.getElementById('prnTotal').textContent = fmt(sale.total);
      document.getElementById('prnCash').textContent = fmt(sale.cash);
      document.getElementById('prnChange').textContent = fmt((sale.cash || 0) - sale.total);
      window.print();
    }

    // === SALES LIST ===
    function renderSales(){
      const sales = store.get('sales',[]).slice().reverse();
      const from = document.getElementById('sFrom').value ? new Date(document.getElementById('sFrom').value) : null;
      const to   = document.getElementById('sTo').value   ? new Date(document.getElementById('sTo').value)   : null;
      const rows = sales.filter(s=>{
        const d = new Date(s.ts);
        if(from && d < from) return false;
        if(to){ const tend=new Date(to); tend.setHours(23,59,59,999); if(d>tend) return false; }
        return true;
      }).map(s=>`<tr>
        <td>${new Date(s.ts).toLocaleString('id-ID')}</td>
        <td>${s.id}</td>
        <td class='right'>${fmt(s.items.length)}</td>
        <td class='right'>${fmt(s.total)}</td>
        <td>${s.cashier}</td>
        <td class='row'>
          <button class='btn-ghost' onclick="reprint('${s.id}')">Cetak</button>
          <button class='btn-bad' onclick="removeSale('${s.id}')">Hapus</button>
        </td>
      </tr>`).join('');
      document.getElementById('tblSales').innerHTML = rows || `<tr><td colspan='6' class='muted'>Belum ada transaksi</td></tr>`;
    }
    
    function reprint(id){
      const s = store.get('sales',[]).find(x=>x.id===id); 
      if(!s) return;
      printSale(s);
    }
    
    function removeSale(id){
      if(!confirm('Hapus transaksi ini? Stok TIDAK otomatis kembali.')) return;
      const list = store.get('sales',[]).filter(x=>x.id!==id); 
      store.set('sales',list); 
      renderSales();
    }

    // === OPNAME ===
    function renderOpname(){
      const prods = store.get('products',[]);
      const rows = prods.map(p=>`<tr>
        <td>${p.name}</td>
        <td class='right'>${fmt(p.stock||0)}</td>
        <td class='right'><input style='width:120px' type='number' id='op_${p.id}' placeholder='Hitung' /></td>
      </tr>`).join('');
      document.getElementById('tblOpname').innerHTML = rows || `<tr><td colspan='3' class='muted'>Belum ada produk</td></tr>`;
    }
    
    function applyOpname(){
      const prods = store.get('products',[]);
      let adjCount=0;
      for(const p of prods){
        const el = document.getElementById('op_'+p.id); if(!el) continue;
        const counted = el.value===''?null:Number(el.value);
        if(counted===null || isNaN(counted)) continue;
        const diff = counted - (p.stock||0);
        if(diff===0) continue;
        if(diff>0){ // treat as stock in
          const rec = {id:uid('IN'),pid:p.id,qty:diff,ts:now(),note:'Opname (+)'};
          const ins = store.get('stockIn',[]); ins.push(rec); store.set('stockIn',ins);
        }else{ // stock out
          const rec = {id:uid('OUT'),pid:p.id,qty:Math.abs(diff),ts:now(),note:'Opname (-)'};
          const outs = store.get('stockOut',[]); outs.push(rec); store.set('stockOut',outs);
        }
        p.stock = counted; adjCount++;
      }
      store.set('products',prods);
      if(adjCount===0) alert('Tidak ada perubahan opname'); else alert('Opname diterapkan ke '+adjCount+' produk');
      renderOpname();
    }

    // === INIT ===
    if(store.get('session')){ session = store.get('session'); go('sec-menu'); }
    setLoginState();
  </script>
  <footer>
    Powered by <b>KKN 17 Desa Narawita 2025</b><br>
    Universitas Ma'soem
  </footer>

</body>
</html>


